<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano ä¸“å±ç§æœ‰å›¾åºŠ</title>
    <style>
        :root { --bg: #f4f6f8; --card: #ffffff; --primary: #2563eb; --primary-hover: #1d4ed8; --text: #1e293b; --text-light: #64748b; --border: #e2e8f0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; color: var(--text); }
        
        /* å®¹å™¨ç»Ÿä¸€æ ·å¼ */
        .box { background: var(--card); border-radius: 16px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); transition: 0.3s; }
        
        /* --- ç™»å½•ç•Œé¢ --- */
        #loginView { width: 100%; max-width: 360px; padding: 40px 30px; text-align: center; }
        .logo-icon { font-size: 48px; margin-bottom: 20px; display: inline-block; }
        h2 { margin: 0 0 24px 0; font-size: 22px; font-weight: 600; }
        .input-group { margin-bottom: 20px; text-align: left; }
        input[type="password"], input[type="text"], select { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 15px; outline: none; transition: 0.2s; background: #f8fafc; }
        input:focus, select:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .btn { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; transition: 0.2s; }
        .btn:hover { background: var(--primary-hover); }

        /* --- ä¸»ç•Œé¢ (å¤§æ°”çš„çœ‹æ¿) --- */
        #mainView { width: 100%; max-width: 760px; padding: 30px; display: none; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .header h3 { margin: 0; font-size: 18px; color: var(--text-light); font-weight: 500; }
        .logout-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 14px; }

        /* è¶…å¤§ä¸Šä¼ åŒº */
        .upload-area { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 60px 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; background: #f8fafc; margin-bottom: 24px; }
        .upload-area:hover, .upload-area.dragover { border-color: var(--primary); background: #eff6ff; }
        .upload-icon { width: 64px; height: 64px; fill: #94a3b8; margin-bottom: 16px; transition: 0.2s; }
        .upload-area:hover .upload-icon { fill: var(--primary); transform: translateY(-5px); }
        .upload-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .upload-subtitle { font-size: 14px; color: var(--text-light); }

        /* ç°ä»£ç½‘æ ¼è®¾ç½®é¢æ¿ */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .setting-item { display: flex; flex-direction: column; gap: 8px; font-size: 14px; }
        .setting-item label { font-weight: 500; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .range-wrap { display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex: 1; accent-color: var(--primary); cursor: pointer; }

        .result { margin-top: 20px; padding: 16px; border-radius: 8px; font-size: 14px; display: none; line-height: 1.6; }
        .result.success { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
        .result.error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
        .result a { color: var(--primary); text-decoration: none; font-weight: 600; word-break: break-all; }
    </style>
</head>
<body>

<div class="box" id="loginView">
    <div class="logo-icon">ğŸ”</div>
    <h2>Nano ä¸“å±å›¾åºŠ</h2>
    <div class="input-group">
        <input type="password" id="passInput" placeholder="è¯·è¾“å…¥è®¿é—®å¯†é’¥..." onkeydown="if(event.key==='Enter') login()">
    </div>
    <button class="btn" onclick="login()">å®‰å…¨ç™»å½•</button>
</div>

<div class="box" id="mainView">
    <div class="header">
        <h3>Nano Dashboard</h3>
        <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>

    <div class="upload-area" id="dropZone">
        <svg class="upload-icon" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.36 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
        <div class="upload-title">ç‚¹å‡»ã€æ‹–æ‹½æˆ–ç²˜è´´å›¾ç‰‡è‡³æ­¤</div>
        <div class="upload-subtitle">æ”¯æŒ WebP å‹ç¼© Â· é˜…åå³ç„š Â· æœ€å¤§ 100MB</div>
    </div>
    <input type="file" id="fileInput" style="display: none;" accept="image/*">

    <div class="settings-grid">
        <div class="setting-item">
            <label><input type="checkbox" id="useWebp" checked> å‹ç¼©å¹¶è½¬ä¸º WebP</label>
            <div class="range-wrap">è´¨é‡ <input type="range" id="qualitySlider" min="10" max="100" value="90"> <span id="qualityVal" style="color:var(--primary);font-weight:bold;">90</span></div>
        </div>
        <div class="setting-item">
            <label><input type="checkbox" id="addWm"> æ·»åŠ æ–‡å­—æ°´å°</label>
            <input type="text" id="wmText" placeholder="@img.ouch.top" style="display: none;">
        </div>
        <div class="setting-item">
            <label>è‡ªåŠ¨åˆ é™¤ (é˜…åå³ç„š)</label>
            <select id="expireSelect">
                <option value="0">æ°¸ä¹…ä¿ç•™ (ä¸åˆ é™¤)</option>
                <option value="1">1 å¤©ååˆ é™¤</option>
                <option value="7">7 å¤©ååˆ é™¤</option>
                <option value="30">30 å¤©ååˆ é™¤</option>
            </select>
        </div>
        <div class="setting-item">
            <label><input type="checkbox" id="autoCopy" checked> ä¸Šä¼ åè‡ªåŠ¨å¤åˆ¶é“¾æ¥</label>
        </div>
    </div>

    <div id="result" class="result"></div>
</div>

<script>
    // --- çŠ¶æ€ç®¡ç† (ç™»å½•é€»è¾‘) ---
    const loginView = document.getElementById('loginView');
    const mainView = document.getElementById('mainView');
    const passInput = document.getElementById('passInput');
    
    // æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²ç™»å½•
    if (localStorage.getItem('nano_token')) {
        loginView.style.display = 'none';
        mainView.style.display = 'block';
    }

    async function login() {
        const token = passInput.value.trim();
        if(!token) return alert('è¯·è¾“å…¥å¯†ç ');
        
        // è°ƒç”¨åç«¯éªŒè¯æ¥å£
        const res = await fetch('/verify', { headers: { 'X-Auth-Token': token } });
        if (res.ok) {
            localStorage.setItem('nano_token', token);
            loginView.style.display = 'none';
            mainView.style.display = 'block';
        } else {
            alert('å¯†ç é”™è¯¯ï¼');
        }
    }

    function logout() {
        localStorage.removeItem('nano_token');
        mainView.style.display = 'none';
        loginView.style.display = 'block';
        passInput.value = '';
    }

    // --- UI äº¤äº’ ---
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const resultDiv = document.getElementById('result');
    const qualitySlider = document.getElementById('qualitySlider');
    const qualityVal = document.getElementById('qualityVal');
    const addWm = document.getElementById('addWm');
    const wmText = document.getElementById('wmText');

    qualitySlider.oninput = (e) => qualityVal.innerText = e.target.value;
    addWm.onchange = (e) => wmText.style.display = e.target.checked ? 'block' : 'none';

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => dropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }));
    dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => { dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFiles(e.target.files);
    document.onpaste = (e) => { if (e.clipboardData.files.length) handleFiles(e.clipboardData.files); };

    function showResult(msg, isSuccess) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = msg;
        resultDiv.className = `result ${isSuccess ? 'success' : 'error'}`;
    }

    // --- ä¸Šä¼ é€»è¾‘ ---
    async function handleFiles(files) {
        if (!files.length) return;
        const file = files[0];
        const token = localStorage.getItem('nano_token');
        if (!token) return logout();

        showResult('ğŸš€ æ­£åœ¨å¤„ç†å¹¶ä¸Šä¼ ...', true);
        try {
            let finalFile = file;
            let fileName = file.name;
            const useWebp = document.getElementById('useWebp').checked;
            const isWm = addWm.checked;
            
            // å‰ç«¯å¤„ç†ï¼šå‹ç¼©å’Œæ°´å°
            if (file.type !== 'image/gif' && (useWebp || isWm)) {
                finalFile = await processImage(file, useWebp, parseInt(qualitySlider.value)/100, isWm ? wmText.value : '');
                fileName = useWebp ? `${Date.now()}.webp` : fileName;
            }

            // è·å–è¿‡æœŸæ—¶é—´è®¾ç½®
            const expireDays = document.getElementById('expireSelect').value;

            const formData = new FormData(); 
            formData.append('file', finalFile, fileName);
            // ä¼ ç»™åç«¯è¿‡æœŸæ—¶é—´
            formData.append('expire_days', expireDays);

            const res = await fetch('/upload', { method: 'POST', headers: { 'X-Auth-Token': token }, body: formData });
            
            if (res.status === 401) { logout(); throw new Error('ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'); }
            
            const data = await res.json();
            if (res.ok) {
                let msg = `âœ… ä¸Šä¼ æˆåŠŸï¼<br><a href="${data.url}" target="_blank">${data.url}</a>`;
                if (expireDays > 0) msg += `<br><span style="color:#eab308; font-size:12px;">ğŸ•’ æ­¤å›¾ç‰‡å°†åœ¨ ${expireDays} å¤©åè‡ªåŠ¨é”€æ¯</span>`;
                
                if (document.getElementById('autoCopy').checked) {
                    await navigator.clipboard.writeText(data.url);
                    msg += `<br><span style="color:#059669; font-weight:bold; margin-top:8px; display:inline-block;">(å·²è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿)</span>`;
                }
                showResult(msg, true);
            } else throw new Error(data.detail || 'ä¸Šä¼ å¤±è´¥');
        } catch (e) { showResult('âŒ ' + e.message, false); }
    }

    // Canvas å›¾ç‰‡å¤„ç†å¼•æ“ (ä¸ä¹‹å‰ä¸€è‡´ï¼Œæå…¶é«˜æ•ˆ)
    function processImage(file, toWebp, quality, wmText) {
        return new Promise((resolve) => {
            const img = new Image(); img.src = URL.createObjectURL(file);
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width; canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                if (wmText) {
                    const fontSize = Math.max(20, Math.min(img.width, img.height) * 0.05);
                    ctx.font = `bold ${fontSize}px -apple-system, sans-serif`;
                    ctx.fillStyle = "rgba(255, 255, 255, 0.85)";
                    ctx.textAlign = "right"; ctx.textBaseline = "bottom";
                    ctx.shadowColor = "rgba(0, 0, 0, 0.6)"; ctx.shadowBlur = 4; ctx.shadowOffsetX = 2; ctx.shadowOffsetY = 2;
                    ctx.fillText(wmText, img.width - (fontSize*0.5), img.height - (fontSize*0.5));
                }
                canvas.toBlob(blob => resolve(blob), toWebp ? 'image/webp' : file.type, quality);
            };
        });
    }
</script>
</body>
</html>