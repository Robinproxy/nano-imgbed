<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano æç®€å›¾åºŠ</title>
    <style>
        :root { 
            --bg: #f8fafc; 
            --card: #ffffff; 
            --text-main: #0f172a; 
            --text-muted: #64748b; 
            --border: #e2e8f0; 
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success-bg: #dcfce7;
            --success-text: #166534;
            --danger: #ef4444;
        }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; justify-content: center; min-height: 100vh; align-items: flex-start; padding-top: 5vh; -webkit-font-smoothing: antialiased; }
        
        .container { background: var(--card); border-radius: 24px; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08); width: 100%; max-width: 860px; padding: 40px; box-sizing: border-box; margin: 0 20px 40px; border: 1px solid #f1f5f9; }

        /* --- å‘Šåˆ«ä¸§è‘¬é£çš„ç™»å½•ç•Œé¢ --- */
        #loginView { text-align: center; max-width: 420px; margin: 8vh auto; padding: 50px 40px; }
        .icon-circle { width: 72px; height: 72px; background: #eff6ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; color: var(--accent); box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.05); }
        .icon-svg { stroke: currentColor; stroke-width: 1.5; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .login-title { font-size: 22px; font-weight: 600; margin: 0 0 8px; letter-spacing: -0.5px; }
        .login-sub { color: var(--text-muted); font-size: 14px; margin-bottom: 32px; }
        .input-box { width: 100%; padding: 16px; border-radius: 12px; border: 1px solid var(--border); font-size: 15px; text-align: center; margin-bottom: 24px; box-sizing: border-box; outline: none; transition: 0.2s; background: #f8fafc; color: var(--text-main); }
        .input-box:focus { border-color: var(--accent); background: #fff; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .btn-primary { width: 100%; padding: 16px; background: var(--accent); color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2); }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3); }

        /* --- å¯¼èˆªæ  --- */
        #mainView { display: none; }
        .nav { display: flex; gap: 32px; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 12px; align-items: center; }
        .nav-item { font-size: 15px; font-weight: 600; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: 8px; padding-bottom: 12px; margin-bottom: -13px; transition: 0.2s; position: relative;}
        .nav-item:hover { color: var(--text-main); }
        .nav-item.active { color: var(--accent); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--accent); border-radius: 2px; }
        .nav-logout { margin-left: auto; color: var(--danger); font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; }

        /* --- ä¸Šä¼ å¤§åŒº --- */
        .upload-zone { border: 2px dashed #cbd5e1; border-radius: 16px; padding: 70px 20px; text-align: center; cursor: pointer; background: #f8fafc; transition: all 0.3s ease; margin-bottom: 20px; }
        .upload-zone:hover { border-color: var(--accent); background: #eff6ff; }
        .upload-zone svg { color: #94a3b8; margin-bottom: 16px; width: 56px; height: 56px; transition: 0.3s; }
        .upload-zone:hover svg { color: var(--accent); transform: translateY(-4px); }
        
        /* --- è®¾ç½®æ  (å¸¦æ»‘å—) --- */
        .settings-bar { display: flex; flex-wrap: wrap; gap: 20px; padding: 16px 20px; background: #f8fafc; border-radius: 12px; font-size: 14px; align-items: center; border: 1px solid var(--border); }
        .settings-bar label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500;}
        .ui-input { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 13px; outline: none; color: var(--text-main); }
        .ui-input:focus { border-color: var(--accent); }
        
        /* ç²¾è‡´çš„æ»‘å— */
        .range-wrap { display: flex; align-items: center; gap: 8px; margin-left: -10px; }
        input[type="range"] { width: 80px; accent-color: var(--accent); cursor: pointer; }
        .q-val { font-size: 12px; font-family: monospace; color: var(--accent); font-weight: bold; width: 24px; }

        /* --- ç»“æœä¸å››ç§é“¾æ¥è”åŠ¨å±•ç¤ºåŒº --- */
        .result-box { margin-top: 24px; padding: 24px; border-radius: 16px; background: #f0fdf4; border: 1px solid #bbf7d0; display: none; text-align: center; }
        .url-display { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 13px; font-family: monospace; color: var(--text-main); outline: none; background: #fff; box-sizing: border-box; text-align: center; margin-bottom: 16px; transition: 0.2s; }
        
        .format-group { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        .fmt-btn { padding: 8px 14px; border-radius: 8px; border: 1px solid var(--border); background: #fff; font-size: 13px; font-weight: 600; cursor: pointer; color: var(--text-main); transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        .fmt-btn:hover { background: #f1f5f9; }
        
        .fmt-btn.active-link { background: var(--success-bg); border-color: var(--success-bg); color: var(--success-text); }
        .fmt-btn.active-code { border-color: var(--text-main); color: var(--text-main); box-shadow: 0 0 0 1px var(--text-main); }

        /* --- å›¾åº“ç½‘æ ¼ --- */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 24px; display: none; }
        .g-card { border: 1px solid var(--border); border-radius: 12px; background: var(--card); overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: 0.2s; }
        .g-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #cbd5e1; }
        
        .g-img-box { position: relative; height: 160px; border-bottom: 1px solid var(--border); background-color: #f1f5f9; background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px); background-size: 20px 20px; background-position: center; display: flex; align-items: center; justify-content: center; }
        .g-img-box img { max-width: 100%; max-height: 100%; object-fit: contain; padding: 10px; box-sizing: border-box; }
        
        .g-del { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); color: var(--danger); border: 1px solid var(--border); border-radius: 8px; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .g-del:hover { background: var(--danger); color: #fff; border-color: var(--danger); }

        .g-info { padding: 16px; }
        .g-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .g-meta { font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
    </style>
</head>
<body>

<div class="container" id="loginView">
    <div class="icon-circle">
        <svg class="icon-svg" style="width: 36px; height: 36px;" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
    </div>
    <h2 class="login-title">ç§æœ‰å›¾åºŠå®‰å…¨éªŒè¯</h2>
    <div class="login-sub">è¯·è¾“å…¥æ‚¨çš„ä¸“å±è®¿é—®å¯†é’¥ä»¥ç»§ç»­</div>
    <input type="password" id="passInput" class="input-box" placeholder="" onkeydown="if(event.key==='Enter') login()">
    <button class="btn-primary" onclick="login()">å®‰å…¨è§£é”è¿›å…¥</button>
</div>

<div class="container" id="mainView">
    <div class="nav">
        <div class="nav-item active" id="tabUpload" onclick="switchTab('upload')">
            <svg class="icon-svg" style="width:18px;height:18px;" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
            ä¸Šä¼ å›¾ç‰‡
        </div>
        <div class="nav-item" id="tabGallery" onclick="switchTab('gallery')">
            <svg class="icon-svg" style="width:18px;height:18px;" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            æˆ‘çš„å›¾åº“
        </div>
        <div class="nav-logout" onclick="logout()">
            <svg class="icon-svg" style="width:16px;height:16px;" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            é€€å‡ºç³»ç»Ÿ
        </div>
    </div>

    <div id="panelUpload">
        <div class="upload-zone" id="dropZone">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
            <div style="font-size: 18px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">ç‚¹å‡»ã€æ‹–æ‹½ æˆ– Ctrl+V ç²˜è´´å›¾ç‰‡è‡³æ­¤</div>
            <div style="color: var(--text-muted); font-size: 13px;">å‰ç«¯æ— æŸ WebP å‹ç¼© Â· é˜…åå¯ç„š</div>
        </div>
        <input type="file" id="fileInput" style="display: none;" accept="image/*">

        <div class="settings-bar">
            <label><input type="checkbox" id="cWebp" checked> WebP å‹ç¼©</label>
            <div class="range-wrap">
                <input type="range" id="cQual" min="10" max="100" value="90" oninput="document.getElementById('qv').innerText=this.value">
                <span class="q-val" id="qv">95</span>
            </div>

            <label style="margin-left: 10px;"><input type="checkbox" id="cWm"> æ·»åŠ æ°´å°</label>
            <input type="text" id="vWm" class="ui-input" placeholder="@img.ouch.top" style="width: 120px;">
            
            <select id="cExp" class="ui-input" style="margin-left: auto;">
                <option value="0">æ°¸ä¹…ä¿ç•™</option>
                <option value="1">1å¤©ååˆ é™¤</option>
                <option value="7">7å¤©ååˆ é™¤</option>
            </select>
        </div>

        <div class="result-box" id="resultBox"></div>
    </div>

    <div class="gallery" id="panelGallery"></div>
</div>

<script>
    const $ = id => document.getElementById(id);
    
    // ç™»å½•æ ¡éªŒ
    function checkLogin() {
        if (localStorage.getItem('nano_token')) {
            $('loginView').style.display = 'none'; $('mainView').style.display = 'block';
        } else {
            $('loginView').style.display = 'block'; $('mainView').style.display = 'none';
        }
    }
    checkLogin();

    async function login() {
        const pwd = $('passInput').value.trim();
        if (!pwd) return alert('è¯·è¾“å…¥å¯†ç ï¼');
        try {
            const res = await fetch('/verify', { headers: { 'X-Auth-Token': pwd } });
            if (res.ok) { localStorage.setItem('nano_token', pwd); checkLogin(); } 
            else alert('å¯†ç é”™è¯¯ï¼');
        } catch (error) { alert('åç«¯æœªå“åº”'); }
    }

    function logout() { localStorage.removeItem('nano_token'); $('passInput').value = ''; checkLogin(); }

    function switchTab(tab) {
        $('tabUpload').classList.toggle('active', tab === 'upload');
        $('tabGallery').classList.toggle('active', tab === 'gallery');
        $('panelUpload').style.display = tab === 'upload' ? 'block' : 'none';
        $('panelGallery').style.display = tab === 'gallery' ? 'grid' : 'none';
        if (tab === 'gallery') loadGallery();
    }

    // ä¸Šä¼ ç»‘å®š
    const dz = $('dropZone');
    dz.onclick = () => $('fileInput').click();
    $('fileInput').onchange = e => handleFiles(e.target.files);
    document.onpaste = e => { if (e.clipboardData.files.length) handleFiles(e.clipboardData.files); };
    ['dragover', 'dragleave', 'drop'].forEach(evt => dz.addEventListener(evt, e => e.preventDefault()));
    dz.addEventListener('drop', e => handleFiles(e.dataTransfer.files));

    async function handleFiles(files) {
        if (!files.length) return;
        const file = files[0];
        const token = localStorage.getItem('nano_token');
        if (!token) return logout();

        const rb = $('resultBox');
        rb.style.display = 'block';
        rb.innerHTML = '<div style="font-weight: 600; color: var(--success-text);">ğŸš€ å¤„ç†å¹¶ä¸Šä¼ ä¸­...</div>';

        try {
            let finalFile = file;
            if (file.type !== 'image/gif' && ($('cWebp').checked || $('cWm').checked)) {
                // è¯»å–æ»‘å—çš„å€¼ä½œä¸ºå‹ç¼©è´¨é‡
                finalFile = await processImg(file, $('cWebp').checked, parseInt($('cQual').value)/100, $('cWm').checked ? $('vWm').value : '');
            }

            const fd = new FormData();
            fd.append('file', finalFile, file.name);
            fd.append('expire_days', $('cExp').value);

            const res = await fetch('/upload', { method: 'POST', headers: { 'X-Auth-Token': token }, body: fd });
            if (res.status === 401) return logout();
            const data = await res.json();

            if (res.ok) {
                navigator.clipboard.writeText(data.url);
                
                const uid = 'up-' + Date.now();
                rb.innerHTML = `
                    <div style="color: var(--success-text); font-weight: 600; font-size: 18px; margin-bottom: 16px;">
                        <svg class="icon-svg" style="width:20px;height:20px;display:inline-block;vertical-align:text-bottom;margin-right:4px;" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        ä¸Šä¼ æˆåŠŸ
                    </div>
                    
                    <input type="text" id="url-${uid}" class="url-display" value="${data.url}" readonly onclick="this.select()">
                    
                    <div class="format-group" id="grp-${uid}">
                        <button class="fmt-btn active-link" onclick="updateFormat('${uid}', this, '${data.url}', 'link')">
                            <svg class="icon-svg" style="width:14px;height:14px;" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.5 4.7l3.4-3.4a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.5-4.7l-3.4 3.4a5 5 0 0 0 7.07 7.07l1.72-1.71"></path></svg>
                            ç›´é“¾
                        </button>
                        <button class="fmt-btn" onclick="updateFormat('${uid}', this, '<img src=&quot;${data.url}&quot;>', 'code')">&lt;/&gt; HTML</button>
                        <button class="fmt-btn" onclick="updateFormat('${uid}', this, '![img](${data.url})', 'code')">Mâ¬‡ Markdown</button>
                        <button class="fmt-btn" onclick="updateFormat('${uid}', this, '[img]${data.url}[/img]', 'code')">[BB] BBCode</button>
                    </div>
                `;
            } else { rb.innerHTML = '<div style="color: red;">âŒ ä¸Šä¼ å¤±è´¥</div>'; }
        } catch (e) { rb.innerHTML = '<div style="color: red;">âŒ å‘ç”Ÿé”™è¯¯</div>'; }
    }

    // --- æ ¸å¿ƒè”åŠ¨é€»è¾‘ï¼šä½ è¦æ±‚ä¸€ç‚¹ä¸è®¸æ”¹çš„åœ°æ–¹ï¼ ---
    async function updateFormat(uid, btn, text, styleType) {
        await navigator.clipboard.writeText(text);
        
        const input = $('url-' + uid);
        input.value = text;
        input.style.backgroundColor = '#fef08a';
        setTimeout(() => input.style.backgroundColor = '#fff', 300);

        const group = $('grp-' + uid);
        Array.from(group.children).forEach(b => {
            b.classList.remove('active-link', 'active-code');
        });

        if (styleType === 'link') {
            btn.classList.add('active-link');
        } else {
            btn.classList.add('active-code');
        }
    }

    // --- å›¾åº“åŠ è½½ ---
    async function loadGallery() {
        const pg = $('panelGallery');
        pg.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 40px;">åŠ è½½ä¸­...</div>';
        try {
            const res = await fetch('/api/history', { headers: { 'X-Auth-Token': localStorage.getItem('nano_token') } });
            if (res.status === 401) return logout();
            const data = await res.json();
            
            if (!data.images.length) {
                pg.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 40px;">å›¾åº“ç©ºç©ºå¦‚ä¹Ÿ</div>';
                return;
            }

            pg.innerHTML = data.images.map(img => {
                const dateStr = new Date(img.time * 1000).toLocaleDateString();
                const uid = 'gal-' + img.time; 
                
                return `
                <div class="g-card" id="card-${img.filename}">
                    <div class="g-img-box">
                        <img src="${img.url}" loading="lazy">
                        <button class="g-del" title="åˆ é™¤" onclick="del('${img.filename}')">
                            <svg class="icon-svg" style="width:14px;height:14px;" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                    
                    <div class="g-info">
                        <div class="g-title" title="${img.filename}">${img.filename}</div>
                        <div class="g-meta">${dateStr}</div>
                        
                        <input type="text" id="url-${uid}" class="url-display" value="${img.url}" readonly onclick="this.select()" style="padding: 10px; font-size: 12px; margin-bottom: 14px;">
                        
                        <div class="format-group" id="grp-${uid}" style="gap: 6px;">
                            <button class="fmt-btn active-link" style="padding: 6px; flex: 1; justify-content: center;" onclick="updateFormat('${uid}', this, '${img.url}', 'link')">
                                <svg class="icon-svg" style="width:14px;height:14px;" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.5 4.7l3.4-3.4a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.5-4.7l-3.4 3.4a5 5 0 0 0 7.07 7.07l1.72-1.71"></path></svg>
                            </button>
                            <button class="fmt-btn" style="padding: 6px; flex: 1; justify-content: center;" onclick="updateFormat('${uid}', this, '<img src=&quot;${img.url}&quot;>', 'code')">&lt;/&gt;</button>
                            <button class="fmt-btn" style="padding: 6px; flex: 1; justify-content: center;" onclick="updateFormat('${uid}', this, '![img](${img.url})', 'code')">Mâ¬‡</button>
                            <button class="fmt-btn" style="padding: 6px; flex: 1; justify-content: center;" onclick="updateFormat('${uid}', this, '[img]${img.url}[/img]', 'code')">[BB]</button>
                        </div>
                    </div>
                </div>
            `}).join('');
        } catch (e) { pg.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: red;">åŠ è½½å¤±è´¥</div>'; }
    }

    async function del(filename) {
        if (!confirm('ç¡®å®šæ°¸ä¹…åˆ é™¤å—ï¼Ÿ')) return;
        const res = await fetch(`/api/delete/${filename}`, { method: 'DELETE', headers: { 'X-Auth-Token': localStorage.getItem('nano_token') } });
        if (res.ok) { $('card-'+filename).remove(); }
    }

    // --- ç»“åˆæ»‘å—è´¨é‡(q)çš„å›¾åƒå¤„ç† ---
    function processImg(file, toWebp, q, wmText) {
        return new Promise(resolve => {
            const img = new Image(); img.src = URL.createObjectURL(file);
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width; canvas.height = img.height;
                const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0);
                
                if (wmText) {
                    const fontSize = Math.max(20, img.width * 0.04);
                    ctx.font = `bold ${fontSize}px sans-serif`; ctx.fillStyle = "rgba(255,255,255,0.8)";
                    ctx.textAlign = "right"; ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 4;
                    ctx.fillText(wmText, img.width - 20, img.height - 20);
                }
                canvas.toBlob(blob => resolve(blob), toWebp ? 'image/webp' : file.type, q);
            };
        });
    }
</script>
</body>
</html>